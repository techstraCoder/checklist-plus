server {
  listen 80;
  server_name localhost;

  root /usr/share/nginx/html;
  index index.html;

  # Serve static assets first under checklistâ€‘plus
  location ^~ /checklist-plus/static/ {
    alias /usr/share/nginx/html/checklistplus/static/;
    # optional: add expires / cache control headers
    try_files $uri =404;
  }

  # Main app routing under /checklist-plus/
  location ^~ /checklist-plus/ {
    alias /usr/share/nginx/html/checklistplus/;   # note trailing slash
    index index.html;
    try_files $uri $uri/ /checklist-plus/index.html;
  }

  # optionally, redirect bare /checklist-plus to include trailing slash
  location = /checklist-plus {
    return 301 /checklist-plus/;
  }
  
  # PHP-FPM handler: ensure POST is handled correctly
  location ~ ^/checklistplus/api/(.+\.php)(/.*)?$ {
    root /var/www/html;
    fastcgi_pass checklistplus-v2-php:9000;
    fastcgi_index index.php;
    fastcgi_split_path_info ^(.+\.php)(/.*)$;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
    include fastcgi_params;

    # Ensure GET and POST are allowed
    limit_except GET POST {
      deny all;
    }
  }

  # Fallback for API endpoint (if not caught above)
  location /checklistplus/api/ {
    try_files $uri $uri/ /checklistplus/api/index.php?$query_string;
  }
}
